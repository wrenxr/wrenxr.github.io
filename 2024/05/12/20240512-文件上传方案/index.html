<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>文件上传方案 | wrenxr's blog</title><meta name="author" content="wrenxr"><meta name="copyright" content="wrenxr"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言传统上，上传文件时，前端先把文件发给后端，后端接收到文件后再落盘或上传至OOS。 随着云服务的发展，前端可以直接上传文件至OOS。但是前端作为第三方向OOS上传文件需要凭证（例如token和秘钥），直接将凭证放入请求体发送上传请求显然是极度危险的。 因此，这里总结一下如何安全地实现前端直传OOS。 传统场景场景说明首先复习一下最传统的文件上传场景，即前端发送文件至后端，后端接收文件后上传至OO">
<meta property="og:type" content="article">
<meta property="og:title" content="文件上传方案">
<meta property="og:url" content="https://wrenxr.github.io/2024/05/12/20240512-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%96%B9%E6%A1%88/index.html">
<meta property="og:site_name" content="wrenxr&#39;s blog">
<meta property="og:description" content="前言传统上，上传文件时，前端先把文件发给后端，后端接收到文件后再落盘或上传至OOS。 随着云服务的发展，前端可以直接上传文件至OOS。但是前端作为第三方向OOS上传文件需要凭证（例如token和秘钥），直接将凭证放入请求体发送上传请求显然是极度危险的。 因此，这里总结一下如何安全地实现前端直传OOS。 传统场景场景说明首先复习一下最传统的文件上传场景，即前端发送文件至后端，后端接收文件后上传至OO">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.pixabay.com/photo/2021/08/01/19/00/cloud-6515064_1280.jpg">
<meta property="article:published_time" content="2024-05-12T08:27:43.000Z">
<meta property="article:modified_time" content="2024-05-12T08:42:21.523Z">
<meta property="article:author" content="wrenxr">
<meta property="article:tag" content="oos">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.pixabay.com/photo/2021/08/01/19/00/cloud-6515064_1280.jpg"><link rel="shortcut icon" href="https://wrenxr-typora.oss-cn-beijing.aliyuncs.com/blog/cat.svg"><link rel="canonical" href="https://wrenxr.github.io/2024/05/12/20240512-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%96%B9%E6%A1%88/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>(()=>{
      const saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
      
      window.btf = {
        saveToLocal: saveToLocal,
        getScript: (url, attr = {}) => new Promise((resolve, reject) => {
          const script = document.createElement('script')
          script.src = url
          script.async = true
          script.onerror = reject
          script.onload = script.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            script.onload = script.onreadystatechange = null
            resolve()
          }

          Object.keys(attr).forEach(key => {
            script.setAttribute(key, attr[key])
          })

          document.head.appendChild(script)
        }),

        getCSS: (url, id = false) => new Promise((resolve, reject) => {
          const link = document.createElement('link')
          link.rel = 'stylesheet'
          link.href = url
          if (id) link.id = id
          link.onerror = reject
          link.onload = link.onreadystatechange = function() {
            const loadState = this.readyState
            if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
            link.onload = link.onreadystatechange = null
            resolve()
          }
          document.head.appendChild(link)
        }),

        addGlobalFn: (key, fn, name = false, parent = window) => {
          const pjaxEnable = false
          if (!pjaxEnable && key.startsWith('pjax')) return

          const globalFn = parent.globalFn || {}
          const keyObj = globalFn[key] || {}
    
          if (name && keyObj[name]) return
    
          name = name || Object.keys(keyObj).length
          keyObj[name] = fn
          globalFn[key] = keyObj
          parent.globalFn = globalFn
        }
      }
    
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode
      
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })()</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '文件上传方案',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-05-12 16:42:21'
}</script><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://wrenxr-typora.oss-cn-beijing.aliyuncs.com/blog/Penguin-green.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.pixabay.com/photo/2021/08/01/19/00/cloud-6515064_1280.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="wrenxr's blog"><span class="site-name">wrenxr's blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">文件上传方案</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-05-12T08:27:43.000Z" title="发表于 2024-05-12 16:27:43">2024-05-12</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-05-12T08:42:21.523Z" title="更新于 2024-05-12 16:42:21">2024-05-12</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">学习记录</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="文件上传方案"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/05/12/20240512-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%96%B9%E6%A1%88/#post-comment"><span class="waline-comment-count" data-path="/2024/05/12/20240512-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%96%B9%E6%A1%88/"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>传统上，上传文件时，前端先把文件发给后端，后端接收到文件后再落盘或上传至OOS。</p>
<p>随着云服务的发展，前端可以直接上传文件至OOS。但是前端作为第三方向OOS上传文件需要<strong>凭证</strong>（例如token和秘钥），直接将凭证放入请求体发送上传请求显然是极度危险的。</p>
<p>因此，这里总结一下如何安全地实现前端直传OOS。</p>
<h1 id="传统场景"><a href="#传统场景" class="headerlink" title="传统场景"></a>传统场景</h1><h2 id="场景说明"><a href="#场景说明" class="headerlink" title="场景说明"></a>场景说明</h2><p>首先复习一下最传统的文件上传场景，即前端发送文件至后端，后端接收文件后上传至OOS或落盘。</p>
<p><img src="https://wrenxr-typora.oss-cn-beijing.aliyuncs.com/img/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%96%B9%E6%A1%88.drawio.svg" alt="文件上传方案.drawio"></p>
<h2 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h2><h3 id="POST请求"><a href="#POST请求" class="headerlink" title="POST请求"></a>POST请求</h3><p><img src="https://wrenxr-typora.oss-cn-beijing.aliyuncs.com/img/image-20240512151138241.png" alt="image-20240512151138241"></p>
<h3 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h3><p>获取post请求体中的参数，包括文件和其他表单数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@RequestParam(&quot;uploader&quot;)</span> String uploader,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@RequestParam(&quot;uploadTime&quot;)</span> String uploadTime)</span> &#123;</span><br><span class="line"></span><br><span class="line">    bpFileService.upload(file, uploader, uploadTime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>处理 &#x2F; 校验文件并落盘。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">uploadToDisk</span><span class="params">(MultipartFile file, String uploader, String uploadTime)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> <span class="string">&quot;D:\\temp\\bp&quot;</span>;</span><br><span class="line">    <span class="type">File</span> <span class="variable">dir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(path);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!dir.exists()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!dir.mkdirs()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Failed to create directory: &quot;</span> + path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">File</span> <span class="variable">diskFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(path, file.getOriginalFilename() + <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!diskFile.createNewFile()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Failed to create file: &quot;</span> + diskFile.getAbsolutePath());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        file.transferTo(diskFile);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// 处理异常情况</span></span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">BPFile</span> <span class="variable">sqlFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BPFile</span>(file.getOriginalFilename(), file.getSize()+<span class="string">&quot;&quot;</span>, uploader, uploadTime, path);</span><br><span class="line">    bpFileDao.insert(sqlFile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="STS上传"><a href="#STS上传" class="headerlink" title="STS上传"></a>STS上传</h1><blockquote>
<p>阿里云STS（Security Token Service）是阿里云提供的一种临时访问权限管理服务。RAM提供RAM用户和RAM角色两种身份。其中，RAM角色不具备永久身份凭证，而只能通过STS获取可以自定义时效和访问权限的临时身份凭证，即安全令牌（STS Token）。</p>
</blockquote>
<h2 id="场景说明-1"><a href="#场景说明-1" class="headerlink" title="场景说明"></a>场景说明</h2><p>在典型的Client&#x2F;Server架构中，服务器端负责接收并处理客户端的请求，并将OSS作为后端的存储服务。客户端将要上传的文件发送给服务器端，然后服务器端再将数据转发上传到OSS。在这个过程中，一份数据需要在网络上传输两次，分别为从客户端到服务器端，再从服务器端到OSS。当访问量较大时，服务器端需要有足够的<strong>带宽资源</strong>来满足多个客户端同时上传的需求，这对架构的伸缩性提出了挑战。</p>
<p>为了解决以上场景带来的挑战，OSS提供了授权给第三方上传的功能。使用该功能，每个客户端可以直接将文件上传到OSS而不是通过服务器端转发，不仅节省了自建服务器的成本，而且充分利用了OSS的海量数据处理能力，无需考虑带宽和并发限制等，可以让客户专心于业务处理。</p>
<p><img src="https://wrenxr-typora.oss-cn-beijing.aliyuncs.com/img/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%96%B9%E6%A1%882.drawio.svg" alt="文件上传方案2.drawio"></p>
<h2 id="示例代码-1"><a href="#示例代码-1" class="headerlink" title="示例代码"></a>示例代码</h2><h3 id="POST请求-1"><a href="#POST请求-1" class="headerlink" title="POST请求"></a>POST请求</h3><p><img src="https://wrenxr-typora.oss-cn-beijing.aliyuncs.com/img/image-20240512151138241.png" alt="image-20240512151138241"></p>
<h3 id="Controller-1"><a href="#Controller-1" class="headerlink" title="Controller"></a>Controller</h3><p>获取post请求体中的参数，调用生成临时凭证的API并返回结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/upload&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Response&lt;STSCredentials&gt; <span class="title function_">upload</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@RequestParam(&quot;uploader&quot;)</span> String uploader,</span></span><br><span class="line"><span class="params">                                       <span class="meta">@RequestParam(&quot;uploadTime&quot;)</span> String uploadTime)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">STSCredentials</span> <span class="variable">credentials</span> <span class="operator">=</span> bpFileService.upload(file, uploader, uploadTime);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Response</span>&lt;&gt;(Code.OK, credentials);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="POJO"><a href="#POJO" class="headerlink" title="POJO"></a>POJO</h3><p>封装返回给前端的临时凭证。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">STSCredentials</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String expiration;</span><br><span class="line">    <span class="keyword">private</span> String accessKeyId;</span><br><span class="line">    <span class="keyword">private</span> String accessKeySecret;</span><br><span class="line">    <span class="keyword">private</span> String securityToken;</span><br><span class="line">    <span class="keyword">private</span> String requestId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Service-1"><a href="#Service-1" class="headerlink" title="Service"></a>Service</h3><p>调用STSService生成临时凭证。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> STSService sts;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> STSCredentials <span class="title function_">upload</span><span class="params">(MultipartFile file, String uploader, String uploadTime)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> sts.getTempAccessCredentials();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过RAM用户的<code>AccessKeyId</code>和<code>AccessKeySecret</code>生成临时访问凭证。</p>
<p>临时访问凭证包括安全令牌（SecurityToken）、临时访问密钥（AccessKeyId和AccessKeySecret）以及过期时间（Expiration）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">STSService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;OSS_ACCESS_KEY_ID&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessKeyId;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;OSS_ACCESS_KEY_SECRET&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessKeySecret;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;OSS_STS_ROLE_ARN&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String roleArn;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;BUCKET_NAME&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String bucketName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得临时访问凭证</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> STSCredentials <span class="title function_">getTempAccessCredentials</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(accessKeyId);</span><br><span class="line">        System.out.println(accessKeySecret);</span><br><span class="line">        System.out.println(roleArn);</span><br><span class="line">        System.out.println(bucketName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// STS服务接入点，例如sts.cn-hangzhou.aliyuncs.com。您可以通过公网或者VPC接入STS服务。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> <span class="string">&quot;sts.cn-beijing.aliyuncs.com&quot;</span>;</span><br><span class="line">        <span class="comment">// 自定义角色会话名称，用来区分不同的令牌，例如可填写为SessionTest。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">roleSessionName</span> <span class="operator">=</span> <span class="string">&quot;ArccSessionTest&quot;</span>;</span><br><span class="line">        <span class="comment">// 以下Policy用于限制仅允许使用临时访问凭证向目标存储空间examplebucket下的src目录上传文件。</span></span><br><span class="line">        <span class="comment">// 临时访问凭证最后获得的权限是步骤4设置的角色权限和该Policy设置权限的交集，即仅允许将文件上传至目标存储空间examplebucket下的src目录。</span></span><br><span class="line">        <span class="comment">// 如果policy为空，则临时访问凭证将获得角色拥有的所有权限。</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">policy</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;Version\&quot;: \&quot;1\&quot;, \n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;Statement\&quot;: [\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;Action\&quot;: [\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                \&quot;oss:PutObject\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            ], \n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;Resource\&quot;: [\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                \&quot;acs:oss:*:*:&quot;</span> + bucketName + <span class="string">&quot;/src/*\&quot; \n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            ], \n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;Effect\&quot;: \&quot;Allow\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    ]\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="comment">// 临时访问凭证的有效时间，单位为秒。最小值为900，最大值以当前角色设定的最大会话时间为准。当前角色最大会话时间取值范围为3600秒~43200秒，默认值为3600秒。</span></span><br><span class="line">        <span class="comment">// 在上传大文件或者其他较耗时的使用场景中，建议合理设置临时访问凭证的有效时间，确保在完成目标任务前无需反复调用STS服务以获取临时访问凭证。</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">durationSeconds</span> <span class="operator">=</span> <span class="number">3600L</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// regionId表示RAM的地域ID。以华东1（杭州）地域为例，regionID填写为cn-hangzhou。也可以保留默认值，默认值为空字符串（&quot;&quot;）。</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">regionId</span> <span class="operator">=</span> <span class="string">&quot;cn-beijing&quot;</span>;</span><br><span class="line">            <span class="comment">// 添加endpoint。适用于Java SDK 3.12.0及以上版本。</span></span><br><span class="line">            DefaultProfile.addEndpoint(regionId, <span class="string">&quot;Sts&quot;</span>, endpoint);</span><br><span class="line">            <span class="comment">// 添加endpoint。适用于Java SDK 3.12.0以下版本。</span></span><br><span class="line">            <span class="comment">// DefaultProfile.addEndpoint(&quot;&quot;,regionId, &quot;Sts&quot;, endpoint);</span></span><br><span class="line">            <span class="comment">// 构造default profile。</span></span><br><span class="line">            <span class="type">IClientProfile</span> <span class="variable">profile</span> <span class="operator">=</span> DefaultProfile.getProfile(regionId, accessKeyId, accessKeySecret);</span><br><span class="line">            <span class="comment">// 构造client。</span></span><br><span class="line">            <span class="type">DefaultAcsClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultAcsClient</span>(profile);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">AssumeRoleRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AssumeRoleRequest</span>();</span><br><span class="line">            <span class="comment">// 适用于Java SDK 3.12.0及以上版本。</span></span><br><span class="line">            request.setSysMethod(MethodType.POST);</span><br><span class="line">            <span class="comment">// 适用于Java SDK 3.12.0以下版本。</span></span><br><span class="line">            <span class="comment">//request.setMethod(MethodType.POST);</span></span><br><span class="line">            request.setRoleArn(roleArn);</span><br><span class="line">            request.setRoleSessionName(roleSessionName);</span><br><span class="line">            request.setPolicy(policy);</span><br><span class="line">            request.setDurationSeconds(durationSeconds);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">AssumeRoleResponse</span> <span class="variable">response</span> <span class="operator">=</span> client.getAcsResponse(request);</span><br><span class="line">            <span class="type">STSCredentials</span> <span class="variable">credentials</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">STSCredentials</span>();</span><br><span class="line">            credentials.setExpiration(response.getCredentials().getExpiration());</span><br><span class="line">            credentials.setAccessKeyId(response.getCredentials().getAccessKeyId());</span><br><span class="line">            credentials.setAccessKeySecret(response.getCredentials().getAccessKeySecret());</span><br><span class="line">            credentials.setSecurityToken(response.getCredentials().getSecurityToken());</span><br><span class="line">            credentials.setRequestId(response.getRequestId());</span><br><span class="line">            <span class="comment">// System.out.println(&quot;Expiration: &quot; + response.getCredentials().getExpiration());</span></span><br><span class="line">            <span class="comment">// System.out.println(&quot;Access Key Id: &quot; + response.getCredentials().getAccessKeyId());</span></span><br><span class="line">            <span class="comment">// System.out.println(&quot;Access Key Secret: &quot; + response.getCredentials().getAccessKeySecret());</span></span><br><span class="line">            <span class="comment">// System.out.println(&quot;Security Token: &quot; + response.getCredentials().getSecurityToken());</span></span><br><span class="line">            <span class="comment">// System.out.println(&quot;RequestId: &quot; + response.getRequestId());</span></span><br><span class="line">            <span class="keyword">return</span> credentials;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClientException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;Failed：&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Error code: &quot;</span> + e.getErrCode());</span><br><span class="line">            System.out.println(<span class="string">&quot;Error message: &quot;</span> + e.getErrMsg());</span><br><span class="line">            System.out.println(<span class="string">&quot;RequestId: &quot;</span> + e.getRequestId());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="表单上传"><a href="#表单上传" class="headerlink" title="表单上传"></a>表单上传</h1><h2 id="场景说明-2"><a href="#场景说明-2" class="headerlink" title="场景说明"></a>场景说明</h2><p>OSS表单上传允许网页应用通过标准HTML表单直接将文件上传至OSS。这种方式下，在前端页面选择文件后，浏览器发起POST请求直接将文件传输到OSS服务器，而无需经过网站服务器中转，减轻了服务器的压力，提高了文件上传的效率和稳定性。</p>
<blockquote>
<p>注意：通过表单上传的方式上传的Object大小不能超过5 GB。</p>
</blockquote>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><p><strong>表单上传广泛应用于Web应用程序，包括但不限于以下几个方面：</strong></p>
<ul>
<li>用户资料上传：注册账号时上传头像、身份证照片或其他身份验证材料。在个人中心修改信息时上传新的头像或背景图。</li>
<li>文件分享与存储：在网盘服务、协同办公平台等通过表单上传各种格式的文件，如文档、图片、音频、视频等至云端进行存储和共享。</li>
<li>内容创作与发布：在博客、论坛、问答社区等平台编写文章并通过表单上传图片、附件等作为内容补充。</li>
<li>电商管理：商家在电商平台后台上传商品图片、详细描述文件、资质证书等；买家在购买过程中上传发票需求或其他证明材料。</li>
<li>在线教育平台：学生在提交作业或项目时上传文档、PPT、视频等作业文件；教师在课程建设时上传教学资料、课件等。</li>
<li>求职招聘网站：求职者上传简历、作品集等求职材料；企业发布职位时上传公司LOGO、招聘信息文件等。</li>
<li>问卷调查与反馈：填写在线调查问卷时上传附加的证据文件或说明文档。</li>
<li>软件开发协作：在代码托管平台如GitHub、GitLab等上传代码文件或项目文档。</li>
</ul>
<h3 id="方案概述"><a href="#方案概述" class="headerlink" title="方案概述"></a>方案概述</h3><p>在服务端生成PostObject所需的Post签名、PostPolicy等信息，然后客户端可以凭借这些信息，在一定的限制下不依赖OSS SDK直接上传文件。PostPolicy可以用于限制客户端上传的文件，例如限制文件大小、文件类型。</p>
<blockquote>
<p>注意：此方案适用于通过HTML表单上传的方式上传文件，不支持基于分片上传大文件、基于分片断点续传的场景。</p>
</blockquote>
<p><img src="https://wrenxr-typora.oss-cn-beijing.aliyuncs.com/img/CAEQYBiBgICKj9ur2hgiIDZhMDRjMzdjN2M0OTRlMzQ5NGVlNjRhZGNmNzg1ODA03963382_20230830144006.372.svg" alt="image"></p>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><h3 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h3><p>通过RAM用户密钥获取OOS实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OssConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;END_POIINT&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">endpoint</span> <span class="operator">=</span> <span class="string">&quot;oss-cn-beijing.aliyuncs.com&quot;</span>;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;BUCKET_NAME&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String bucket ;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定上传到 OSS 的文件前缀</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">dir</span> <span class="operator">=</span> <span class="string">&quot;arcc/&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定过期时间，单位为秒</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">expireTime</span> <span class="operator">=</span> <span class="number">3600</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造 host</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> <span class="string">&quot;http://&quot;</span> + bucket + <span class="string">&quot;.&quot;</span> + endpoint;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;OSS_ACCESS_KEY_ID&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessKeyId;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;OSS_ACCESS_KEY_SECRET&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessKeySecret;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> OSS ossClient;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> OSS <span class="title function_">getOssClient</span><span class="params">()</span> &#123;</span><br><span class="line">        ossClient = <span class="keyword">new</span> <span class="title class_">OSSClientBuilder</span>().build(endpoint, accessKeyId, accessKeySecret);</span><br><span class="line">        <span class="keyword">return</span> ossClient;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getHost</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> host;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getAccessKeyId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accessKeyId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getExpireTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> expireTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getDir</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dir;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreDestroy</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">        ossClient.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Controller-2"><a href="#Controller-2" class="headerlink" title="Controller"></a>Controller</h3><p>生成Post签名和Post Policy等信息返回给前端。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PostSignatureController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OSS ossClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OssConfig ossConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/get_post_signature_for_oss_upload&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generatePostSignature</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">expireEndTime</span> <span class="operator">=</span> System.currentTimeMillis() + ossConfig.getExpireTime() * <span class="number">1000</span>;</span><br><span class="line">            <span class="type">Date</span> <span class="variable">expiration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(expireEndTime);</span><br><span class="line">            <span class="type">PolicyConditions</span> <span class="variable">policyConds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PolicyConditions</span>();</span><br><span class="line">            policyConds.addConditionItem(PolicyConditions.COND_CONTENT_LENGTH_RANGE, <span class="number">0</span>, <span class="number">1048576000</span>);</span><br><span class="line">            policyConds.addConditionItem(MatchMode.StartWith, PolicyConditions.COND_KEY, ossConfig.getDir());</span><br><span class="line">            <span class="type">String</span> <span class="variable">postPolicy</span> <span class="operator">=</span> ossClient.generatePostPolicy(expiration, policyConds);</span><br><span class="line">            <span class="type">byte</span>[] binaryData = postPolicy.getBytes(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">encodedPolicy</span> <span class="operator">=</span> BinaryUtil.toBase64String(binaryData);</span><br><span class="line">            <span class="type">String</span> <span class="variable">postSignature</span> <span class="operator">=</span> ossClient.calculatePostSignature(postPolicy);</span><br><span class="line">            response.put(<span class="string">&quot;ossAccessKeyId&quot;</span>, ossConfig.getAccessKeyId());</span><br><span class="line">            response.put(<span class="string">&quot;policy&quot;</span>, encodedPolicy);</span><br><span class="line">            response.put(<span class="string">&quot;signature&quot;</span>, postSignature);</span><br><span class="line">            response.put(<span class="string">&quot;dir&quot;</span>, ossConfig.getDir());</span><br><span class="line">            response.put(<span class="string">&quot;host&quot;</span>, ossConfig.getHost());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (</span><br><span class="line">                OSSException oe) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Caught an OSSException, which means your request made it to OSS, &quot;</span></span><br><span class="line">                    + <span class="string">&quot;but was rejected with an error response for some reason.&quot;</span>);</span><br><span class="line">            <span class="comment">// 假设此方法存在</span></span><br><span class="line">            System.out.println(<span class="string">&quot;HTTP Status Code: &quot;</span> + oe.getRawResponseError());</span><br><span class="line">            System.out.println(<span class="string">&quot;Error Message: &quot;</span> + oe.getErrorMessage());</span><br><span class="line">            System.out.println(<span class="string">&quot;Error Code:       &quot;</span> + oe.getErrorCode());</span><br><span class="line">            System.out.println(<span class="string">&quot;Request ID:      &quot;</span> + oe.getRequestId());</span><br><span class="line">            System.out.println(<span class="string">&quot;Host ID:           &quot;</span> + oe.getHostId());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClientException ce) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Caught an ClientException, which means the client encountered &quot;</span></span><br><span class="line">                    + <span class="string">&quot;a serious internal problem while trying to communicate with OSS, &quot;</span></span><br><span class="line">                    + <span class="string">&quot;such as not being able to access the network.&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Error Message: &quot;</span> + ce.getMessage());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ossClient != <span class="literal">null</span>) &#123;</span><br><span class="line">                ossClient.shutdown();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="两者异同"><a href="#两者异同" class="headerlink" title="两者异同"></a>两者异同</h1><p>STS和表单上传都能做到权限控制与定时销毁。</p>
<p>不同的是，表单上传在客户端通过JavaScript代码完成签名，然后通过表单直传数据到OSS，期间完全不需要服务端的参与。当然，如若设计更加复杂的权限控制、签名管理或<strong>设置上传回调</strong>等功能，就需要服务端的参与。</p>
<blockquote>
<p> 详细见：<a target="_blank" rel="noopener" href="https://help.aliyun.com/zh/oss/use-cases/use-postobject-to-upload-objects-by-using-web-clients">如何在Web端通过表单上传数据到OSS_对象存储(OSS)-阿里云帮助中心 (aliyun.com)</a></p>
</blockquote>
<p>因此，表单上传适用于简单的文件上传场景，特别是在需要向公众开放上传功能时比较常见。</p>
<p>而STS授权更适用于需要更严格的权限控制或者需要将上传任务分发给第三方的场景，例如，将上传任务分发给移动端应用或者其他服务器。相比于表单上传有更高的灵活性和安全性，但是也更复杂一点。</p>
<p><del>其实还是搞不太清楚……姑且先这么理解吧QࡇQ</del></p>
<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/461803154/answer/3178042223">上传文件应该经过后端吗，还是直接上传至阿里oss? - yearu的回答 - 知乎</a></li>
<li><a target="_blank" rel="noopener" href="https://help.aliyun.com/zh/oss/developer-reference/use-temporary-access-credentials-provided-by-sts-to-access-oss?spm=a2c4g.11186623.0.i3">使用STS临时访问凭证访问OSS_对象存储(OSS)-阿里云帮助中心 (aliyun.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/120834588">前后端文件上传过程以及方法 - 程序员秋风的文章 - 知乎</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/soraly/p/8441589.html">前端上传文件的方法总结 - soraly - 博客园 (cnblogs.com)</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_45393094/article/details/112056436">MultipartFile工具类（方法详解）-CSDN博客</a></li>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/372950593/answer/1024642089">请问数据保存在txt文件中和数据库中相比有什么利弊啊？ - 未知的健忘的回答 - 知乎</a></li>
<li><a target="_blank" rel="noopener" href="https://help.aliyun.com/zh/oss/user-guide/form-upload">如何使用表单上传_对象存储(OSS)-阿里云帮助中心 (aliyun.com)</a></li>
</ul>
<h1 id="问题记录"><a href="#问题记录" class="headerlink" title="问题记录"></a>问题记录</h1><p><strong>Q</strong>：我在Spring boot项目中定义了一个类，类中使用<code>@Value</code>注解注入了<code>application.yml</code>中的环境变量，类本身没有任何注解。我在其他类中调用该类时，使用new语句创建出的该类的示例拿不到环境变量，但是使用<code>@Autowired</code>注解注入该类的示例可以拿到环境变量，这是为什么？</p>
<p><strong>A</strong>：在 Spring Boot 项目中，使用 <code>@Value</code> 注解注入的属性是由 Spring 容器管理的 bean 属性。当你使用 <code>new</code> 关键字手动创建一个类的实例时，该实例并不是 Spring 容器所管理的 bean，因此无法进行依赖注入。</p>
<p>而当你使用 <code>@Autowired</code> 注解注入该类的示例时，Spring 容器会负责创建该类的实例，并且在实例化过程中注入依赖（比如 <code>@Value</code> 注解注入的属性），因此你能够获取到环境变量的值。</p>
<p>简而言之，使用 <code>@Autowired</code> 注解注入的示例是由 Spring 容器管理的 bean，可以享受到 Spring 提供的各种特性，包括依赖注入。而使用 <code>new</code> 关键字手动创建的示例则不受 Spring 容器的管理，因此无法实现依赖注入。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://wrenxr.github.io">wrenxr</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://wrenxr.github.io/2024/05/12/20240512-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%96%B9%E6%A1%88/">https://wrenxr.github.io/2024/05/12/20240512-文件上传方案/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://wrenxr.github.io" target="_blank">wrenxr's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/oos/">oos</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.pixabay.com/photo/2021/08/01/19/00/cloud-6515064_1280.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/05/17/20240517-%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" title="20240517-单例模式"><img class="cover" src="https://www.itprotoday.com/sites/itprotoday.com/files/styles/article_featured_retina/public/java-logo_0.jpg?itok=wfdR6eAu" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">20240517-单例模式</div></div></a></div><div class="next-post pull-right"><a href="/2024/05/10/20240510-LinkedList%E4%B8%8EStack%E5%B8%B8%E7%94%A8API/" title="LinkedList与Stack常用API"><img class="cover" src="https://www.itprotoday.com/sites/itprotoday.com/files/styles/article_featured_retina/public/java-logo_0.jpg?itok=wfdR6eAu" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">LinkedList与Stack常用API</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="waline-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://wrenxr-typora.oss-cn-beijing.aliyuncs.com/blog/Penguin-green.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">wrenxr</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">14</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">13</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/wrenxr"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content"><p> 欢迎~ ᖰ⌯'▾'⌯ᖳ <br> 评论需要科学上网和审核(｡ ́︿ ̀｡) </p></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E5%9C%BA%E6%99%AF"><span class="toc-number">2.</span> <span class="toc-text">传统场景</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E8%AF%B4%E6%98%8E"><span class="toc-number">2.1.</span> <span class="toc-text">场景说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">2.2.</span> <span class="toc-text">示例代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POST%E8%AF%B7%E6%B1%82"><span class="toc-number">2.2.1.</span> <span class="toc-text">POST请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Controller"><span class="toc-number">2.2.2.</span> <span class="toc-text">Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service"><span class="toc-number">2.2.3.</span> <span class="toc-text">Service</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#STS%E4%B8%8A%E4%BC%A0"><span class="toc-number">3.</span> <span class="toc-text">STS上传</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E8%AF%B4%E6%98%8E-1"><span class="toc-number">3.1.</span> <span class="toc-text">场景说明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81-1"><span class="toc-number">3.2.</span> <span class="toc-text">示例代码</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#POST%E8%AF%B7%E6%B1%82-1"><span class="toc-number">3.2.1.</span> <span class="toc-text">POST请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Controller-1"><span class="toc-number">3.2.2.</span> <span class="toc-text">Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POJO"><span class="toc-number">3.2.3.</span> <span class="toc-text">POJO</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service-1"><span class="toc-number">3.2.4.</span> <span class="toc-text">Service</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95%E4%B8%8A%E4%BC%A0"><span class="toc-number">4.</span> <span class="toc-text">表单上传</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%BA%E6%99%AF%E8%AF%B4%E6%98%8E-2"><span class="toc-number">4.1.</span> <span class="toc-text">场景说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">4.1.1.</span> <span class="toc-text">使用场景</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%A1%88%E6%A6%82%E8%BF%B0"><span class="toc-number">4.1.2.</span> <span class="toc-text">方案概述</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B"><span class="toc-number">4.2.</span> <span class="toc-text">代码示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="toc-number">4.2.1.</span> <span class="toc-text">配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Controller-2"><span class="toc-number">4.2.2.</span> <span class="toc-text">Controller</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%A4%E8%80%85%E5%BC%82%E5%90%8C"><span class="toc-number">5.</span> <span class="toc-text">两者异同</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">6.</span> <span class="toc-text">参考链接</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95"><span class="toc-number">7.</span> <span class="toc-text">问题记录</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/05/17/20240517-%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" title="20240517-单例模式"><img src="https://www.itprotoday.com/sites/itprotoday.com/files/styles/article_featured_retina/public/java-logo_0.jpg?itok=wfdR6eAu" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="20240517-单例模式"/></a><div class="content"><a class="title" href="/2024/05/17/20240517-%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" title="20240517-单例模式">20240517-单例模式</a><time datetime="2024-05-17T01:57:46.000Z" title="发表于 2024-05-17 09:57:46">2024-05-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/12/20240512-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%96%B9%E6%A1%88/" title="文件上传方案"><img src="https://cdn.pixabay.com/photo/2021/08/01/19/00/cloud-6515064_1280.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="文件上传方案"/></a><div class="content"><a class="title" href="/2024/05/12/20240512-%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%96%B9%E6%A1%88/" title="文件上传方案">文件上传方案</a><time datetime="2024-05-12T08:27:43.000Z" title="发表于 2024-05-12 16:27:43">2024-05-12</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/05/10/20240510-LinkedList%E4%B8%8EStack%E5%B8%B8%E7%94%A8API/" title="LinkedList与Stack常用API"><img src="https://www.itprotoday.com/sites/itprotoday.com/files/styles/article_featured_retina/public/java-logo_0.jpg?itok=wfdR6eAu" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="LinkedList与Stack常用API"/></a><div class="content"><a class="title" href="/2024/05/10/20240510-LinkedList%E4%B8%8EStack%E5%B8%B8%E7%94%A8API/" title="LinkedList与Stack常用API">LinkedList与Stack常用API</a><time datetime="2024-05-10T02:50:45.000Z" title="发表于 2024-05-10 10:50:45">2024-05-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/23/20240423-JSR303/" title="JSR303"><img src="https://wrenxr-typora.oss-cn-beijing.aliyuncs.com/blog/JSR303.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="JSR303"/></a><div class="content"><a class="title" href="/2024/04/23/20240423-JSR303/" title="JSR303">JSR303</a><time datetime="2024-04-23T12:55:38.000Z" title="发表于 2024-04-23 20:55:38">2024-04-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/04/18/20240418-Spring%E6%97%A5%E5%BF%97%E5%88%9D%E8%A7%81/" title="日志初见"><img src="https://wrenxr-typora.oss-cn-beijing.aliyuncs.com/blog/covers/logback.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="日志初见"/></a><div class="content"><a class="title" href="/2024/04/18/20240418-Spring%E6%97%A5%E5%BF%97%E5%88%9D%E8%A7%81/" title="日志初见">日志初见</a><time datetime="2024-04-18T03:17:59.000Z" title="发表于 2024-04-18 11:17:59">2024-04-18</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By wrenxr</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>(() => {
  let initFn = window.walineFn || null

  const initWaline = (Fn) => {
    const waline = Fn(Object.assign({
      el: '#waline-wrap',
      serverURL: 'https://waline-test-livid.vercel.app/',
      pageview: false,
      dark: 'html[data-theme="dark"]',
      path: window.location.pathname,
      comment: true,
    }, null))

    const destroyWaline = () => {
      waline.destroy()
    }

    btf.addGlobalFn('pjax', destroyWaline, 'destroyWaline')
  }

  const loadWaline = () => {
    if (initFn) initWaline(initFn)
    else {
      btf.getCSS('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.css')
        .then(() => import('https://cdn.jsdelivr.net/npm/@waline/client/dist/waline.min.js'))
        .then(({ init }) => {
          initFn = init || Waline.init
          initWaline(initFn)
          window.walineFn = initFn
        })
    }
  }

  if ('Waline' === 'Waline' || !false) {
    if (false) btf.loadComment(document.getElementById('waline-wrap'),loadWaline)
    else setTimeout(loadWaline, 0)
  } else {
    window.loadOtherComment = loadWaline
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>